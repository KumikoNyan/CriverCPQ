{% extends "cpq_app/base.html" %}
<head>

    <!-- load bootstrap via jsDeliver urls -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</head>

{% block content %}
<header class="py-3 mb-4 border-bottom">
    <div class="container d-flex flex-wrap justify-content-between align-items-center">
        <!-- Left-aligned section -->
        <div class="d-flex align-items-center">
            <a href="/" class="d-flex align-items-center link-body-emphasis text-decoration-none">
                <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
                <span class="fs-4">Create Quotation</span>
            </a>
        </div>
        <!-- Right-aligned search form -->
        <form class="col-lg-auto mb-lg-0" role="search">
            <input type="search" class="form-control" placeholder="Search..." aria-label="Search">
        </form>
    </div>    
</header>

<div class="container d-flex justify-content-center">
    <form method="POST" style="width:100%;"> {% csrf_token %}   
        <h4> Quotation Attributes </h4>    
        <div class="row">
            <div class="col">
                <label for="name">Customer</label>
                <select class="customer w-100" id="customer_select">\
                    <option value="" selected disabled>Select a Customer</option>
                    {% for customer in customers %}
                    <option value="{{customer.customer_id}}">{{customer.customer_name}}</option>
                    {% endfor %}
                    <option value="delete" hidden></option>
                </select>
            </div>
            <div class="col">
                <label for="name">Address</label>
                <input type="text" class="customer_address form-control" placeholder="Address" readonly>
            </div>
            <div class="col">
                <label for="name">Project</label>
                <input type="text" class="project form-control" placeholder="Project">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="name">Mobile Number</label>
                <input type="text" class="customer_mobile form-control" placeholder="Mobile Number" readonly>
            </div>
            <div class="col">
                <label for="name">Email Address</label>
                <input type="text" class="customer_email form-control" placeholder="Email Address" readonly>
            </div>
        </div>
        <hr>
        
        <div class="row row-cols-auto">
            <div class="col justify-content-center">
                <h4> Quotation Items </h4>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <label for="supplier_default">Default Supplier</label>
                <select class="supplier_default form-select" id="supplier" name="supplier_default">
                    <option value="" selected disabled>Select a Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{supplier.supplier_id}}">{{supplier.supplier_name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-2">
                <label for="finish_default_glass ">Default Aluminum Finish</label>
                <select class="finish_default_aluminum form-select" id="type" name="type">
                    <option value="delete" hidden></option>
                    <option value="" disabled>Select Aluminum Finish</option>
                    <option value="Mill-Finish" selected>Mill-Finish</option>
                    <option value="Anodized">Anodized</option>
                    <option value="Analok">Analok</option>
                    <option value="Powdercoated">Powdercoated</option>
                </select>
            </div>
            <div class="col-2">
                <label for="finish_default_glass ">Default Glass Finish</label>
                <select class="finish_default_glass form-select" id="type" name="type">
                    <option value="delete" hidden></option>
                    <option value="" disabled>Select Glass Finish</option>
                    <option value="Clear" selected>Clear</option>
                    <option value="Tempered">Tempered</option>
                    <option value="Laminated">Laminated</option>
                </select>
            </div>
            <div class="col-2">
                <label for="name">Margin </label>
                <input type="number" class="quotation_margin form-control" value="30">
            </div>
            <div class="col-2">
                <label for="name">Labor </label>
                <input type="number" class="quotation_labor form-control" value="30">
            </div>
        </div>
        <div class="row">  
            <div class="item_container">
            </div>
        </div>
        <button type="button" class="btn btn-primary mt-2 addItem" id="addItem">Add Item</button>
        <button type="button" class="btn btn-primary mt-2 ms-2 addItem" id="total_bom">Total Bill of Materials</button>

        <div class="row pt-3 mt-3">
            <div class="col-6">
                <a href="{% url 'quotation_list' %}" class="btn btn-secondary w-100">Cancel</a>
            </div>
            <div class="col-6">
                <button type="button" class="submit-btn btn btn-primary w-100">Create Quote</button>
            </div>
        </div>
    </form>
</div>
<div class="mt-4 card px-3 py-2" id="quoteItem_row_temp" style="display:none;">
    <!-- Supplier/Product Row -->
    <div class="row">
        <div class="col">
            <h6 class="fw-bold">Quotation Item #</h5>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">
            <label for="supplier">Supplier</label>
            <select class="supplier form-select" id="supplier" name="supplier">
                <option value="" selected disabled>Select a Supplier</option>
                {% for supplier in suppliers %}
                <option value="{{supplier.supplier_id}}">{{supplier.supplier_name}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="product">Product</label>
            <select class="product_id form-select" id="product" name="product">
                <option value="" selected disabled>Select Product</option>
                <option value="delete" hidden></option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="aluminum_finish">Aluminum Finish</label>
            <select class="aluminum_finish bom-finish form-select" id="aluminum_finish" name="aluminum_finish">
                <option value="" disabled>Select Finish</option>
                <option value="Mill-Finish" selected>Mill-Finish</option>
                <option value="Anodized">Anodized</option>
                <option value="Analok">Analok</option>
                <option value="Powdercoated">Powdercoated</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="glass_finish">Glass Finish</label>
            <select class="glass_finish bom-finish form-select" id="glass_finish" name="glass_finish">
                <option value="" disabled selected>Select Glass Finish</option>
                <option value="Clear">Clear</option>
                <option value="Tempered">Tempered</option>
                <option value="Laminated">Laminated</option>
            </select>
        </div>
    </div>

    <!-- Quantity and Dimensions -->
    <div class="row mt-2 align-items-center">
        <div class="col-md-2">
            <label>Quantity</label>
            <input type="number" class="item_quantity form-control" placeholder="Qty" value="1" min="1">
        </div>
        <div class="col-md-4">
            <label>Dimensions (W x H)</label>
            <div class="d-flex align-items-center">
                <input type="number" class="item_width form-control text-center" placeholder="Width" value="1" min="1">
                <span class="mx-2">X</span>
                <input type="number" class="item_height form-control text-center" placeholder="Height" value="1" min="1">
            </div>
        </div>
    </div>

    <!-- Buttons -->
    <div class="row mt-2 align-items-center">
        <div class="col-md-10">
            <button type="button" class="btn btn-outline-primary bom" data-modal-id="modal" data-loaded="false">
                See Bill of Materials
            </button>
        </div>
        <div class="col-md-2 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm btn-delete delete-quoteItem" data-row-id="quoteItem_row">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
    </div>
</div>


<div class="modal fade" id="bom_modal_template" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel"><h4>BOM for <span id="modal_productName"></span></h4></h5>
                <button type="button" class="btn-close close-bom" data-bs-dismiss="modal" aria-label="Close" data-item-id=""></button>
            </div>
            <div class="modal-body">
                <table class="table table-borderless table-hover align-middle" id="bomTable" cellpadding="5">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Finish</th>
                            <th>Qty per Item</th>
                            <th>Material Cost per Item</th>
                            <th>Total Quantity</th>
                            <th>Total Cost</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="download_excel_btn btn btn-success" data-filename="bill_of_materials">Download Excel</button>
                <button type="button" class="btn btn-secondary close-bom" data-bs-dismiss="modal" data-item-id="">Close</button>
                <button type="button" class="btn btn-primary save-bom" data-item-id="" data-exclude-material-ids="">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="total_bom_modal" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel"><h4>BOM for <span id="modal_productName"></span></h4></h5>
                <button type="button" class="btn-close close-bom" data-bs-dismiss="modal" aria-label="Close" data-item-id=""></button>
            </div>
            <div class="modal-body">
                <table class="table table-borderless table-hover align-middle" id="bomTable" cellpadding="5">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Finish</th>
                            <th>Total Quantity</th>
                            <th>Total Cost</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="download_excel_btn btn btn-success" data-filename="total_bom">Download Excel</button>
                <button type="button" class="btn btn-secondary close-bom" data-bs-dismiss="modal" data-item-id="">Close</button>
                <button type="button" class="btn btn-primary save-bom" data-item-id="" data-exclude-material-ids="">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="bom_modal_container">
    
</div>


<script>
    const item_container = $('.item_container');
    const bom_modal_template = $('#bom_modal_template')
    const item_template = $('#quoteItem_row_temp');
    const bom_modal_container = $('.bom_modal_container');
    const default_glass_finish = $('.finish_default_glass')
    const default_aluminum_finish = $('.finish_default_aluminum')
    const quotation_margin = $('.quotation_margin')
    const quotation_labor = $('.quotation_labor')
    const total_bom = $('#total_bom')
    const project_input = $('.project')
    let latestBOMresponse = null;
    let savedBOMs = {};
    rowCounter_addItem = 0;

    $(document).ready(function () {
        const addItem_button = $('#addItem');
        const customer_select = $('#customer_select')
        
        $(document).on("change", ".supplier_default", function () {
            let supplierId = $(this).val();
            let default_prodSelect = $('#quoteItem_row_temp').find('.product_id')
            let default_supplier = $('#quoteItem_row_temp').find('.supplier')
            console.log(default_supplier)
            console.log("Default supplier changed:", supplierId);
        
            if (supplierId) {
                $.ajax({
                    url: "/get_products/", 
                    type: "GET",
                    data: { supplier_id: supplierId },
                    dataType: "json",
                    success: function (response) {
                        default_prodSelect.empty();  
                        default_prodSelect.append('<option value="" disabled selected>Select Product</option>');
                        default_prodSelect.append('<option value="delete" hidden></option>');
        
                        if (response.products.length > 0) {
                            response.products.forEach(function (product) {
                                default_prodSelect.append(`<option value="${product.product_id}">${product.product_name}</option>`);
                            });
                        } else {
                            default_prodSelect.append('<option value="" disabled>No Products Available</option>');
                        }
    
                        default_supplier.val(supplierId)
                    },
                    error: function () {
                        alert("Failed to fetch products. Please try again.");
                    }
                });
            }
        });
        $(document).on("change", ".supplier", function () {
            let supplierId = $(this).val();  
            let productSelect = $(this).closest(".row").find(".product_id"); 
            
            console.log("Supplier changed:", supplierId);
        
            if (supplierId) {
                $.ajax({
                    url: "/get_products/", 
                    type: "GET",
                    data: { supplier_id: supplierId },
                    dataType: "json",
                    success: function (response) {
                        productSelect.empty();  
                        productSelect.append('<option value="" disabled selected>Select Product</option>');
                        productSelect.append('<option value="delete" hidden></option>');
        
                        if (response.products.length > 0) {
                            response.products.forEach(function (product) {
                                productSelect.append(`<option value="${product.product_id}">${product.product_name}</option>`);
                            });
                        } else {
                            productSelect.append('<option value="" disabled>No Products Available</option>');
                        }
                    },
                    error: function () {
                        alert("Failed to fetch products. Please try again.");
                    }
                });
            }
        });
        $(document).on('click', '.delete-quoteItem', function () {
            let rowId = $(this).data('row-id');
            let row = $('#' + rowId);

            let idElement = row.find('.product_id');
            
            idElement.val('delete');
            row.hide();
            console.log("deleted row: " + row.attr('id'))
            console.log(idElement.val())
        });
        $("#addItem").click(function() {
            let button = $(this);
            console.log("works")

            rowCounter_addItem++;
            let newRow = item_template.clone();
            
            newRow.attr('id', 'quoteItem_row' + rowCounter_addItem);
            newRow.addClass("quoteItem_row");
            
            newRow.find('.delete-quoteItem').attr('data-row-id', 'quoteItem_row' + rowCounter_addItem);
            newRow.find('.bom').attr('data-modal-id', 'bom_modal' + rowCounter_addItem).attr('id', 'bom' + rowCounter_addItem)

            newRow.find(".product_id")
            .append('<option value="delete" hidden></option>')
            let selectedDefaultSupplier = item_template.find('.supplier').val();
            newRow.find('.supplier').val(selectedDefaultSupplier).trigger('change');

            let selectedAluminumFinish = default_aluminum_finish.val();
            let selectedGlassFinish =   default_glass_finish.val();

            newRow.find('.glass_finish').val(selectedGlassFinish).trigger('change');
            newRow.find('.aluminum_finish').val(selectedAluminumFinish).trigger('change');

            newRow.find('h6').text('Quotation Item #' + rowCounter_addItem);

            newRow.show();
            item_container.append(newRow);

            let newModal = bom_modal_template.clone();
            newModal.attr('id', 'bom_modal' + rowCounter_addItem)
            newModal.find('.close-bom').each(function () {
                $(this).data('item-id', rowCounter_addItem);
            });
            newModal.find('.save-bom').data('item-id', rowCounter_addItem)
            bom_modal_container.append(newModal)
            console.log("created row and modal: " + newRow.attr('id') + newModal.attr('id') + newRow.find('.bom').attr('data-modal-id'))
        })
        $(document).on('click', '.delete-bomItem', function () {
            let rowId = $(this).data('row-id');
            let row = $('#' + rowId);
            let materialId = rowId.split("bomItem_row")[1];
        
            row.attr('id', 'delete');
            row.hide();
        
            console.log("Deleted material ID:", materialId);
        
            let modal = $(this).closest('.modal');
            let bom_button = modal.find('.save-bom');
        
            let idsRaw = bom_button.data('exclude-material-ids') || ''
            let ids = idsRaw ? idsRaw.split('-') : [];
            ids.push(materialId)
        
            let updatedIds = ids.join('-');
        
            bom_button.attr('data-exclude-material-ids', updatedIds);
            bom_button.data('exclude-material-ids', updatedIds);
        
            console.log("Updated exclude-material-ids:", updatedIds, bom_button.data('exclude-material-ids'));
        });
        
        
        $(document).on('click', '.close-bom', function () {
            let itemId = $(this).data('item-id');
            let row = $('#quoteItem_row' + itemId);
            let button = row.find('.bom')

            let modal = $(this).closest(".modal");
            let button_save_bom = modal.find('.save-bom')
            let previous_exclude = '';
            if (savedBOMs[itemId]) {
                previous_exclude = savedBOMs[itemId].excluded_materials;
            }
            console.log(button_save_bom)
            button.data('loaded', false)
            button_save_bom.data('exclude-material-ids', previous_exclude)
        });
        $(document).on("click", ".save-bom", function () {
            let modal = $(this).closest(".modal");
            let item_id = $(this).data('item-id')
            let button = $('#bom' + item_id)
        

            let excluded_materials = $(this).data('exclude-material-ids')
            let product_margin = modal.find(".bom_product_margin").val()
            let labor_margin = modal.find(".bom_labor_margin").val()
        
            // Save it
            savedBOMs[item_id] = {
                excluded_materials,
                product_margin,
                labor_margin
            };
            button.data('loaded', false)
            modal.modal('hide');
        });
        $(document).on('change', '.bom-finish', function () {
            let row = $(this).parent().parent().parent();
            let button = row.find('.bom');
    
            button.data('loaded', false)
        });
        $(".submit-btn").click(function() {
            let isValid = true;
            let material_data = [];
        
            $(".form-control, .form-select").removeClass("is-invalid");

            let customer_id = $(".customer").val();
            let project = $(".project").val();

            if (!customer_id) {
                console.log("Product name is missing");
                $(".customer").addClass("is-invalid");
                isValid = false;
            }
            if (!project) {
                console.log("Product category is missing");
                $(".project").addClass("is-invalid");
                isValid = false;
            }
            
            item_container.find('.quoteItem_row').each(function () {
                let item_row = $(this);
                
                let item_id = item_row.attr('id').replace("quoteItem_row", "")
                let item_supplier = item_row.find(".supplier").val();
                let product_id = item_row.find(".product_id").val();
                let item_quantity = item_row.find(".item_quantity").val();
                let item_width = item_row.find(".item_width").val();
                let item_height = item_row.find(".item_height").val();
                let glass_finish = item_row.find(".glass_finish").val();
                let aluminum_finish = item_row.find(".aluminum_finish").val();
                
                if (product_id === 'delete' || product_id === null) {
                    return; 
                }
                
                let excluded_materials = [];
    
                if (savedBOMs[item_id]) {
                    let rawExcluded = savedBOMs[item_id].excluded_materials;
                    excluded_materials = rawExcluded ? rawExcluded.toString().split('-') : [];
                } else {
                    excluded_materials = [];

                }
                let submit_margin = quotation_margin.val();
                let submit_labor = quotation_labor.val();
                
                if (!item_quantity) {
                    item_row.find(".item_quantity").addClass("is-invalid");
                    isValid = false;
                }
                if (!item_height) {
                    item_row.find(".item_height").addClass("is-invalid");
                    isValid = false;
                }
                if (!item_width) {
                    item_row.find(".item_width").addClass("is-invalid");
                    isValid = false;
                }
                if (!product_id) {
                    item_row.find(".product_id").addClass("is-invalid");
                    isValid = false;
                }

                material_data.push({
                    'item_id': item_id,
                    'product_id': product_id,
                    'item_supplier': item_supplier,
                    'item_quantity': item_quantity,
                    'item_width': item_width,
                    'item_height': item_height,
                    'glass_finish': glass_finish,
                    'aluminum_finish': aluminum_finish,
                    'excluded_materials': excluded_materials,
                    'submit_margin': submit_margin,
                    'submit_labor':submit_labor,
                });
                
            });
            if (!isValid) {
                alert("Please fill in all required fields.");
                return;
            }

            // Prepare Data
            let submit_data = {
                'customer_id': customer_id,
                'project': project,
                'item_data': JSON.stringify(material_data),
                "csrfmiddlewaretoken": $("[name=csrfmiddlewaretoken]").val(),
            };
        
            console.log(submit_data);
            // Submit Data via AJAX
            $.ajax({
                method: "post",
                data: submit_data,
                success: function(data) {
                    console.log(data["status"]);
                    console.log(data);
                    if (data["status"]) {
                        window.location = data["url"];
                    } else {
                        alert(data["error"]);
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert("Something broke");
                }
            });
        });
        customer_select.select2({
            theme: 'bootstrap-5',
            placeholder: "Select Customer",
            allowClear: true,
        });

        
        customer_select.on('change', function() {
            let customerId = $(this).val();
            
            if (customerId) {
                $.ajax({
                    url: '/get_customer',  
                    type: 'GET',
                    data: { customer_id: customerId },
                    dataType: 'json',
                    success: function(response) {
                        if (response) {
                            $('.customer_address').val(response.address);
                            $('.customer_mobile').val(response.mobile);
                            $('.customer_email').val(response.email);
                        } else {
                            clearCustomerFields();
                        }
                    },
                    error: function() {
                        alert('Failed to fetch customer details.');
                        clearCustomerFields();
                    }
                });
            } else {
                $('.customer_address').val('');
                $('.customer_mobile').val('');
                $('.customer_email').val('');
            }
        });


        total_bom.click(function() {
            let item_container = $('.item_container');  // Your container for the quote items
            let submit_data = [];
            let isValid = true;
            $(".form-control, .form-select").removeClass("is-invalid");
            // Iterate over each quoteItem_row in the container
            item_container.find('.quoteItem_row').each(function () {
                let item_row = $(this);
                
                let item_id = item_row.attr('id').replace("quoteItem_row", "")
                let item_supplier = item_row.find(".supplier").val();
                let product_id = item_row.find(".product_id").val();
                let item_quantity = item_row.find(".item_quantity").val();
                let item_width = item_row.find(".item_width").val();
                let item_height = item_row.find(".item_height").val();
                let glass_finish = item_row.find(".glass_finish").val();
                let aluminum_finish = item_row.find(".aluminum_finish").val();
                
                let excluded_materials = [];
                
    
                if (savedBOMs[item_id]) {
                    let rawExcluded = savedBOMs[item_id].excluded_materials;
                    excluded_materials = rawExcluded ? rawExcluded.toString().split('-') : [];
                } else {
                    excluded_materials = [];

                }
                let submit_margin = quotation_margin.val();
                let submit_labor = quotation_labor.val();
                
                if (!item_quantity) {
                    item_row.find(".item_quantity").addClass("is-invalid");
                    isValid = false;
                }
                if (!item_height) {
                    item_row.find(".item_height").addClass("is-invalid");
                    isValid = false;
                }
                if (!item_width) {
                    item_row.find(".item_width").addClass("is-invalid");
                    isValid = false;
                }
                if (!product_id) {
                    item_row.find(".product_id").addClass("is-invalid");
                    isValid = false;
                }

                submit_data.push({
                    'item_id': item_id,
                    'product_id': product_id,
                    'item_supplier': item_supplier,
                    'item_quantity': item_quantity,
                    'item_width': item_width,
                    'item_height': item_height,
                    'glass_finish': glass_finish,
                    'aluminum_finish': aluminum_finish,
                    'excluded_materials': excluded_materials,
                    'submit_margin': submit_margin,
                    'submit_labor':submit_labor,
                });
                
            });
            if (!isValid) {
                alert("Please fill in all required fields.");
                return;
            }
        
        
            $.ajax({
                url: "/get_total_bom/", 
                type: "POST",  
                data: {
                    'submit_data': JSON.stringify(submit_data),  
                    'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val()
                },
                dataType: "json",
                success: function (response) {
                    console.log('Success');
                    console.log(response);
                    latestBOMresponse = response;
        
                    // Handle the modal display
                    let bom_modal = $('#total_bom_modal');
                    let bom_modal_tbody = bom_modal.find('tbody');
        
                    // Clear the current table data
                    bom_modal_tbody.empty();
        
                    // Iterate through the BOM response and add rows to the modal
                    response.bom.forEach(material => {
                        let row = `
                            <tr id="bomItem_row${material.material_id}">
                                <td>${material.material_name}</td>
                                <td>${material.material_finish}</td>
                                <td>${material.material_unit_total_quantity}${material.material_unit}</td>
                                <td>${material.material_total_cost}</td>
                            </tr>`;
                        bom_modal_tbody.append(row);
                    });
        
                    // Add the summary rows at the end
                    bom_modal_tbody.append(`
                        <tr><td colspan="5"></td></tr>
                        <tr><td colspan="5"></td></tr>
                        <tr><td colspan="5"></td></tr>
                        <tr>
                            <td>Total</td>
                            <td></td>
                            <td>${response.item_quantity} items</td>
                            <td>${response.total_cost_of_materials}</td>
                        </tr>
                        <tr>
                            <td style="width:15%;">
                                <div class="d-flex align-items-center">
                                    <span>${response.product_margin}% Profit</span>
                                </div>
                            </td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td style="width:15%;">
                                <div class="d-flex align-items-center">
                                    <input type="number" class="product_id_hidden form-control" value="${response.product_id}" hidden>
                                    <span>${response.labor_margin}% Labor</span>
                                </div>
                            </td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Price</td>
                            <td></td>
                            <td>${response.item_quantity} items</td>
                            <td>${response.total_price}</td>
                        </tr>`);
        
                    // Show the modal with the BOM data
                    bom_modal.modal('show');
                },
                error: function () {
                    alert("Failed to fetch the total BOM. Please try again.");
                }
            });
        });
        $(document).on('click', '.download_excel_btn', function () {
            // Build the data array for the Excel file
            let response = latestBOMresponse;
            let filename = $(this).data('filename')

            let excelData = [
                ["Material Name", "Finish", "Total Quantity", "Unit", "Total Cost"]
            ];

            response.bom.forEach(material => {
                excelData.push([
                    material.material_name,
                    material.material_finish,
                    material.material_unit_total_quantity,
                    material.material_unit,
                    material.material_total_cost
                ]);
            });

            // Add summary
            excelData.push([]);
            excelData.push(["Total", "", response.item_quantity + " items", "", response.total_cost_of_materials]);
            excelData.push(["Profit Margin", "", "", "", response.product_margin + "%"]);
            excelData.push(["Labor Margin", "", "", "", response.labor_margin + "%"]);
            excelData.push(["Final Price", "", response.item_quantity + " items", "", response.total_price]);

            let worksheet = XLSX.utils.aoa_to_sheet(excelData);
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "BOM");

            XLSX.writeFile(workbook, "total_bom.xlsx");
        });
    });
    $(document).on("click", ".bom", function () {
        let button = $(this);
        let modal_id = button.data('modal-id')
        let alreadyLoaded = button.data('loaded');
        let bom_modal = $('#' + modal_id)
        
        if (alreadyLoaded) {
            console.log("already loaded")
            bom_modal.modal('show');
            return;
        }
        let item_id = modal_id.replace("bom_modal", "")

        let excluded_materials = [];

        if (savedBOMs[item_id]) {
            let rawExcluded = savedBOMs[item_id].excluded_materials;
            excluded_materials = rawExcluded ? rawExcluded.toString().split('-') : [];
        } else {
            excluded_materials = [];
        }

        let submit_margin = quotation_margin.val();
        let submit_labor = quotation_labor.val();

        let bom_modal_productLabel = bom_modal.find('#modal_productName')
        let bom_modal_tbody = bom_modal.find('tbody')
        let isValid = true;
        let item_row = $(this).parent().parent().parent();
        let item_supplier = item_row.find(".supplier").val()
        let product_id = item_row.find(".product_id").val()
        let item_quantity = item_row.find(".item_quantity").val()
        let item_width = item_row.find(".item_width").val()
        let item_height = item_row.find(".item_height").val()
        let glass_finish = item_row.find(".glass_finish").val()
        let aluminum_finish = item_row.find(".aluminum_finish").val()

        $(".form-control, .form-select").removeClass("is-invalid");

        if (!item_quantity) {
            item_row.find(".item_quantity").addClass("is-invalid");
            isValid = false;
        }
        if (!item_height) {
            item_row.find(".item_height").addClass("is-invalid");
            isValid = false;
        }
        if (!item_width) {
            item_row.find(".item_width").addClass("is-invalid");
            isValid = false;
        }
        if (!product_id) {
            item_row.find(".product_id").addClass("is-invalid");
            isValid = false;
        }

        if (!isValid) {
            alert("Please fill in all required fields.");
            return;
        }

        let submit_data = {
            'product_id': product_id,
            'item_supplier': item_supplier,
            'item_quantity': item_quantity,
            'item_width': item_width,
            'item_height': item_height,
            'glass_finish': glass_finish,
            'aluminum_finish': aluminum_finish,
            'excluded_materials': excluded_materials,
            'quotation_margin': submit_margin,
            'quotation_labor': submit_labor,
            'item_id': item_id,
            'csrfmiddlewaretoken': $("[name=csrfmiddlewaretoken]").val(),
        };
        
        $.ajax({
            url: "/get_bill_of_materials/", 
            type: "GET",
            data: submit_data,
            dataType: "json",
            success: function (response) {
                console.log('Success')
                console.log(response)
                latestBOMresponse = response;

                console.log(latestBOMresponse)

                bom_modal_productLabel.text(response.product);
                bom_modal_tbody.empty();
    
                response.bom.forEach(material => {
                    let row = `
                        <tr id="${response.item_id}bomItem_row${material.material_id}">
                            <td>${material.material_name}</td>
                            <td>${material.material_finish}</td>
                            <td>${material.material_single_item_quantity}${material.material_unit}</td>
                            <td>${material.material_single_item_quantity_cost}</td>
                            <td>${material.material_unit_total_quantity}${material.material_unit}</td>
                            <td>${material.material_total_cost}</td>
                            <td>
                                <button type="button" class="btn btn-close btn-delete delete-bomItem" data-row-id="${response.item_id}bomItem_row${material.material_id}"></button>
                            </td>
                        </tr>`;

                    bom_modal_tbody.append(row);
                });
 
                bom_modal_tbody.append(`
                    <tr><td colspan="5"></td></tr>
                    <tr><td colspan="5"></td></tr>
                    <tr><td colspan="5"></td></tr>
                    <tr>
                        <td>Total</td>
                        <td></td>
                        <td></td>
                        <td>${response.cost_of_materials_per_item}</td>
                        <td>${response.item_quantity} item/s</td>
                        <td>${response.total_cost_of_materials}</td>
                    </tr>
                    <tr>
                        <td style="width:15%;">
                            <div class="d-flex align-items-center">
                                <span>${response.product_margin}% Profit</span>
                            </div>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td style="width:15%;">
                            <div class="d-flex align-items-center">
                                <input type="number" class="product_id_hidden form-control" value="${response.product_id}" hidden>
                                <span>${response.labor_margin}% Labor</span>
                            </div>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Price</td>
                        <td></td>
                        <td></td>
                        <td>${response.price_per_item}</td>
                        <td>${response.item_quantity} item/s</td>
                        <td>${response.total_price}</td>
                    </tr>`)
                button.data('loaded', true)
                bom_modal.modal('show')
            },
            error: function () {
                alert("Failed to fetch products. Please try again.");
            }
        });
    })
    
    

    
    

</script>
{% endblock %}
